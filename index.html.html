<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visable Company Search</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f9fafb;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
const { useState, useEffect } = React;

// Icons
const Search = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('circle', { cx: "11", cy: "11", r: "8" }), React.createElement('path', { d: "m21 21-4.3-4.3" }));
const Filter = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('polygon', { points: "22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" }));
const Download = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('path', { d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" }), React.createElement('polyline', { points: "7 10 12 15 17 10" }), React.createElement('line', { x1: "12", x2: "12", y1: "15", y2: "3" }));
const Loader = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('line', { x1: "12", x2: "12", y1: "2", y2: "6" }), React.createElement('line', { x1: "12", x2: "12", y1: "18", y2: "22" }), React.createElement('line', { x1: "4.93", x2: "7.76", y1: "4.93", y2: "7.76" }), React.createElement('line', { x1: "16.24", x2: "19.07", y1: "16.24", y2: "19.07" }), React.createElement('line', { x1: "2", x2: "6", y1: "12", y2: "12" }), React.createElement('line', { x1: "18", x2: "22", y1: "12", y2: "12" }), React.createElement('line', { x1: "4.93", x2: "7.76", y1: "19.07", y2: "16.24" }), React.createElement('line', { x1: "16.24", x2: "19.07", y1: "7.76", y2: "4.93" }));
const ChevronDown = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('polyline', { points: "6 9 12 15 18 9" }));
const X = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('line', { x1: "18", x2: "6", y1: "6", y2: "18" }), React.createElement('line', { x1: "6", x2: "18", y1: "6", y2: "18" }));
const ExternalLink = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round" }, React.createElement('path', { d: "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" }), React.createElement('polyline', { points: "15 3 21 3 21 9" }), React.createElement('line', { x1: "10", x2: "21", y1: "14", y2: "3" }));

function CompanySearch() {
  // State
  const [semanticQuery, setSemanticQuery] = useState('');
  const [showFilters, setShowFilters] = useState(false);
  const [isSearching, setIsSearching] = useState(false);
  const [results, setResults] = useState([]);
  const [totalResults, setTotalResults] = useState(0);
  const [currentPage, setCurrentPage] = useState(1);
  const [error, setError] = useState('');
  
  // Selected companies and saved lists
  const [selectedCompanies, setSelectedCompanies] = useState([]);
  const [showSelectedList, setShowSelectedList] = useState(false);
  const [savedLists, setSavedLists] = useState([]);
  const [showSavedLists, setShowSavedLists] = useState(false);
  const [listName, setListName] = useState('');
  const [showSaveDialog, setShowSaveDialog] = useState(false);
  
  // ICP classification
  const [isClassifying, setIsClassifying] = useState(false);
  const [classifiedCompanies, setClassifiedCompanies] = useState([]);
  const [classificationProgress, setClassificationProgress] = useState('');
  const [currentClassifyingList, setCurrentClassifyingList] = useState(null);
  
  // Contact reveal
  const [revealingContacts, setRevealingContacts] = useState(false);
  const [revealProgress, setRevealProgress] = useState('');
  const [companiesWithContacts, setCompaniesWithContacts] = useState([]);
  const [selectedContacts, setSelectedContacts] = useState([]);
  const [showContactsList, setShowContactsList] = useState(false);
  
  // Toast notifications
  const [toasts, setToasts] = useState([]);
  
  // Filters
  const [countries, setCountries] = useState([]);
  const [employeeRanges, setEmployeeRanges] = useState([]);
  const [revenueRanges, setRevenueRanges] = useState([]);
  const [keywords, setKeywords] = useState('');
  const [technologies, setTechnologies] = useState('');
  const [foundedYearMin, setFoundedYearMin] = useState('');
  const [foundedYearMax, setFoundedYearMax] = useState('');
  const [naicsCodes, setNaicsCodes] = useState('');
  
  // Load saved lists from localStorage on mount
  useEffect(() => {
    const saved = localStorage.getItem('visable_company_lists');
    if (saved) {
      setSavedLists(JSON.parse(saved));
    }
  }, []);
  
  // ============================================
  // TOAST NOTIFICATION SYSTEM (replaces alerts!)
  // ============================================
  const showToast = (message, type = 'success') => {
    const id = Date.now();
    const newToast = { id, message, type };
    setToasts(prev => [...prev, newToast]);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
      setToasts(prev => prev.filter(t => t.id !== id));
    }, 4000);
  };
  
  const removeToast = (id) => {
    setToasts(prev => prev.filter(t => t.id !== id));
  };
  
  // Save lists to localStorage whenever they change
  useEffect(() => {
    if (savedLists.length > 0) {
      localStorage.setItem('visable_company_lists', JSON.stringify(savedLists));
    }
  }, [savedLists]);
  
  // Constants
  const visableGreen = '#84BD00';
  const visableNavy = '#002B49';
  const visableOrange = '#FF6B35';
  const COMPANYENRICH_API_KEY = 'G4CG7Y9JVz4eX0nEykxikx';
  const WIZA_API_KEY = '9b1a3dc7adf103da93e7abe5f39e588d54eafdddfaeb9ab540726d3f5f590a3d';
  const PAGE_SIZE = 20;
  
  // Country options
  const countryOptions = [
    { code: 'DE', name: 'Germany' },
    { code: 'AT', name: 'Austria' },
    { code: 'CH', name: 'Switzerland' },
    { code: 'US', name: 'United States' },
    { code: 'GB', name: 'United Kingdom' },
    { code: 'FR', name: 'France' },
    { code: 'IT', name: 'Italy' },
    { code: 'ES', name: 'Spain' },
    { code: 'NL', name: 'Netherlands' },
    { code: 'BE', name: 'Belgium' },
  ];
  
  // Employee ranges
  const employeeOptions = [
    '1-10', '11-50', '51-200', '201-500', '501-1000', '1001-5000', '5001-10000', '10001+'
  ];
  
  // Revenue ranges
  const revenueOptions = [
    '$0-$1M', '$1M-$10M', '$10M-$50M', '$50M-$100M', '$100M-$500M', '$500M-$1B', '$1B-$10B', '$10B+'
  ];
  
  const handleSearch = async (page = 1) => {
    if (!semanticQuery.trim() && countries.length === 0 && employeeRanges.length === 0) {
      setError('Please enter a search query or select at least one filter');
      return;
    }
    
    setIsSearching(true);
    setError('');
    setCurrentPage(page);
    
    try {
      // Build filters
      const filters = {};
      
      if (countries.length > 0) {
        filters.countries = countries;
      }
      
      if (employeeRanges.length > 0) {
        filters.employees = employeeRanges;
      }
      
      if (revenueRanges.length > 0) {
        filters.revenue = revenueRanges;
      }
      
      if (keywords.trim()) {
        filters.keywords = keywords.split(',').map(k => k.trim()).filter(k => k);
      }
      
      if (technologies.trim()) {
        filters.technologies = technologies.split(',').map(t => t.trim()).filter(t => t);
      }
      
      if (foundedYearMin || foundedYearMax) {
        filters.foundedYear = {};
        if (foundedYearMin) filters.foundedYear.min = parseInt(foundedYearMin);
        if (foundedYearMax) filters.foundedYear.max = parseInt(foundedYearMax);
      }
      
      if (naicsCodes.trim()) {
        filters.naicsCode = naicsCodes.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
      }
      
      // Build request body
      const requestBody = {
        page: page,
        pageSize: PAGE_SIZE,
        ...filters
      };
      
      if (semanticQuery.trim()) {
        requestBody.semanticQuery = semanticQuery;
        requestBody.semanticWeight = 0.7;
      }
      
      console.log('üîç Searching with params:', requestBody);
      
      const response = await fetch('https://api.companyenrich.com/companies/search', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${COMPANYENRICH_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });
      
      if (!response.ok) {
        throw new Error(`Search failed: ${response.status}`);
      }
      
      const data = await response.json();
      
      console.log('‚úÖ Search results:', data);
      
      if (page === 1) {
        setResults(data.items || []);
      } else {
        setResults(prev => [...prev, ...(data.items || [])]);
      }
      
      setTotalResults(data.totalItems || 0);
      
    } catch (err) {
      console.error('‚ùå Search error:', err);
      setError(`Search failed: ${err.message}`);
    } finally {
      setIsSearching(false);
    }
  };
  
  const handleLoadMore = () => {
    handleSearch(currentPage + 1);
  };
  
  const toggleCountry = (code) => {
    setCountries(prev => 
      prev.includes(code) ? prev.filter(c => c !== code) : [...prev, code]
    );
  };
  
  const toggleEmployeeRange = (range) => {
    setEmployeeRanges(prev => 
      prev.includes(range) ? prev.filter(r => r !== range) : [...prev, range]
    );
  };
  
  const toggleRevenueRange = (range) => {
    setRevenueRanges(prev => 
      prev.includes(range) ? prev.filter(r => r !== range) : [...prev, range]
    );
  };
  
  const clearFilters = () => {
    setCountries([]);
    setEmployeeRanges([]);
    setRevenueRanges([]);
    setKeywords('');
    setTechnologies('');
    setFoundedYearMin('');
    setFoundedYearMax('');
    setNaicsCodes('');
  };
  
  const exportToCSV = () => {
    if (results.length === 0) {
      showToast('No results to export', 'warning');
      return;
    }
    
    const headers = [
      'Name', 'Domain', 'Website', 'Industry', 'Employees', 'Revenue',
      'Country', 'Description', 'Founded Year', 'Keywords'
    ];
    
    const rows = results.map(company => [
      company.name || '',
      company.domain || '',
      company.website || '',
      company.industry || '',
      company.employees || '',
      company.revenue || '',
      company.location?.country?.name || '',
      (company.description || '').replace(/"/g, '""'),
      company.founded_year || '',
      (company.keywords || []).join('; ')
    ]);
    
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `company_search_${Date.now()}.csv`;
    a.click();
    
    showToast(`Exported ${results.length} companies to CSV`, 'success');
  };
  
  const toggleCompanySelection = (company) => {
    setSelectedCompanies(prev => {
      const isSelected = prev.some(c => c.domain === company.domain);
      if (isSelected) {
        return prev.filter(c => c.domain !== company.domain);
      } else {
        return [...prev, company];
      }
    });
  };
  
  const isCompanySelected = (company) => {
    return selectedCompanies.some(c => c.domain === company.domain);
  };
  
  const clearSelectedCompanies = () => {
    setSelectedCompanies([]);
    setClassifiedCompanies([]);
  };
  
  const saveListDialog = () => {
    if (selectedCompanies.length === 0) {
      showToast('Please select at least one company', 'warning');
      return;
    }
    setShowSaveDialog(true);
  };
  
  const saveList = () => {
    if (!listName.trim()) {
      showToast('Please enter a list name', 'warning');
      return;
    }
    
    const newList = {
      id: Date.now(),
      name: listName,
      companies: selectedCompanies,
      createdAt: new Date().toISOString(),
      companyCount: selectedCompanies.length,
      classified: false
    };
    
    setSavedLists(prev => [...prev, newList]);
    setListName('');
    setShowSaveDialog(false);
    setSelectedCompanies([]);
    
    showToast(`List "${newList.name}" saved with ${newList.companyCount} companies`, 'success');
  };
  
  const deleteList = (listId) => {
    if (confirm('Are you sure you want to delete this list?')) {
      setSavedLists(prev => prev.filter(list => list.id !== listId));
      showToast('List deleted', 'success');
    }
  };
  
  const runICPClassificationOnList = async (list) => {
    setCurrentClassifyingList(list);
    setIsClassifying(true);
    setClassificationProgress('');
    const classified = [];
    
    try {
      for (let i = 0; i < list.companies.length; i++) {
        const company = list.companies[i];
        setClassificationProgress(`Classifying ${i + 1}/${list.companies.length}: ${company.name}...`);
        
        try {
          // SKIP Wiza enrichment - proxy is unreliable and not needed for classification
          // CompanyEnrich data is sufficient for ICP classification
          // Wiza is only needed for contact reveal later
          console.log(`üìä Classifying ${company.name} using CompanyEnrich data only`);
          
          // Classify using only CompanyEnrich data
          const classification = classifyCompany(company, null);
          
          classified.push({
            ...company,
            icp_classification: classification
          });
          
        } catch (err) {
          console.error('Error classifying', company.domain, err);
          classified.push({
            ...company,
            icp_classification: {
              icp_match: false,
              reason: 'Classification error',
              industry: 'Unknown',
              supplier_type: 'Unknown',
              distribution_area: 'Unknown',
              employees: 'Unknown'
            }
          });
        }
        
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // Update the list as classified
      setSavedLists(prev => prev.map(l => 
        l.id === list.id 
          ? { ...l, classified: true, classifiedResults: classified, classifiedAt: new Date().toISOString() }
          : l
      ));
      
      setClassifiedCompanies(classified);
      setClassificationProgress('');
      setCurrentClassifyingList(null);
      
      const icpCount = classified.filter(c => c.icp_classification.icp_match).length;
      showToast(`Classified ${classified.length} companies! ${icpCount} ICP matches found`, 'success');
      
    } catch (err) {
      console.error('Classification error:', err);
      showToast(`Classification failed: ${err.message}`, 'error');
    } finally {
      setIsClassifying(false);
    }
  };
  
  const viewListResults = (list) => {
    if (list.classifiedResults) {
      setClassifiedCompanies(list.classifiedResults);
      setShowSavedLists(false);
    }
  };
  
  const runICPClassification = async () => {
    if (selectedCompanies.length === 0) {
      showToast('Please select at least one company or use a saved list', 'warning');
      return;
    }
    
    setIsClassifying(true);
    setClassificationProgress('');
    const classified = [];
    
    try {
      for (let i = 0; i < selectedCompanies.length; i++) {
        const company = selectedCompanies[i];
        setClassificationProgress(`Classifying ${i + 1}/${selectedCompanies.length}: ${company.name}...`);
        
        try {
          // Get Wiza enrichment
          let wizaData = null;
          try {
            const wizaResponse = await fetch('https://wiza-proxy.onrender.com/api/wiza/company-enrichment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                company_domain: company.domain
              })
            });
            
            if (wizaResponse.ok) {
              wizaData = await wizaResponse.json();
            }
          } catch (err) {
            console.warn('Wiza enrichment failed for', company.domain, err);
          }
          
          // Classify with fallback logic (same as ICP Checker)
          const classification = classifyCompany(company, wizaData);
          
          classified.push({
            ...company,
            icp_classification: classification
          });
          
        } catch (err) {
          console.error('Error classifying', company.domain, err);
          classified.push({
            ...company,
            icp_classification: {
              icp_match: false,
              reason: 'Classification error',
              industry: 'Unknown',
              supplier_type: 'Unknown',
              distribution_area: 'Unknown',
              employees: 'Unknown'
            }
          });
        }
        
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      setClassifiedCompanies(classified);
      setClassificationProgress('');
      
      const icpCount = classified.filter(c => c.icp_classification.icp_match).length;
      showToast(`Classified ${classified.length} companies! ${icpCount} ICP matches found`, 'success');
      
    } catch (err) {
      console.error('Classification error:', err);
      showToast(`Classification failed: ${err.message}`, 'error');
    } finally {
      setIsClassifying(false);
    }
  };
  
  const classifyCompany = (ceData, wizaData) => {
    // ============================================
    // CRITICAL: Detect Tech Giants & Service Companies FIRST
    // ============================================
    const detectTechCompany = () => {
      const name = (ceData?.name || '').toLowerCase();
      const description = (ceData?.description || '').toLowerCase();
      const keywords = (ceData?.keywords || []).join(' ').toLowerCase();
      const industries = (ceData?.industries || []).join(' ').toLowerCase();
      
      // Known tech giants - NEVER ICP
      const techGiants = [
        'apple inc', 'apple computer', 'google', 'alphabet', 'microsoft', 
        'meta platforms', 'facebook', 'amazon.com', 'netflix', 'spotify',
        'uber', 'airbnb', 'tesla', 'twitter', 'x corp', 'linkedin', 
        'snapchat', 'tiktok', 'bytedance', 'salesforce', 'oracle',
        'adobe', 'ibm', 'cisco', 'intel', 'nvidia', 'amd',
        'paypal', 'square', 'stripe', 'shopify', 'zoom'
      ];
      
      for (const giant of techGiants) {
        if (name.includes(giant)) {
          console.log(`üö´ BLOCKED: Tech giant detected - ${name}`);
          return true;
        }
      }
      
      // Software/SaaS companies - NOT industrial B2B
      const softwareIndicators = [
        'software company', 'software development', 'saas platform', 'cloud software',
        'mobile app', 'mobile application', 'app development',
        'social media', 'social network', 'social platform',
        'e-commerce platform', 'online marketplace', 'digital marketplace',
        'streaming service', 'video streaming', 'music streaming',
        'search engine', 'web search', 'internet search',
        'operating system', 'os developer', 'platform developer',
        'game developer', 'video game', 'gaming platform',
        'advertising platform', 'ad tech', 'marketing platform',
        'consumer electronics brand', 'consumer technology',
        'ride sharing', 'food delivery', 'delivery platform',
        'fintech', 'cryptocurrency', 'blockchain platform',
        'artificial intelligence company', 'ai platform', 'machine learning platform'
      ];
      
      for (const indicator of softwareIndicators) {
        if (description.includes(indicator) || keywords.includes(indicator)) {
          console.log(`üö´ BLOCKED: Service/Software company - ${indicator}`);
          return true;
        }
      }
      
      // Check industries for software/internet
      if (industries.includes('software') && industries.includes('internet')) {
        console.log('üö´ BLOCKED: Software + Internet industry combination');
        return true;
      }
      
      return false;
    };
    
    // BLOCK tech companies immediately
    if (detectTechCompany()) {
      return {
        industry: 'Software/Technology (Not ICP)',
        supplier_type: 'Service Provider',
        distribution_area: 'International',
        employees: ceData?.employees || '500+',
        icp_match: false,
        reason: '‚úó Technology/Software company (not industrial B2B)'
      };
    }
    
    // ============================================
    // Extract employee count - IMPROVED VERSION
    // ============================================
    const ceEmployees = ceData?.employees;
    const ceRevenue = ceData?.revenue;
    const ceFunding = ceData?.financial?.total_funding;
    const ceFundingStage = ceData?.financial?.funding_stage;
    
    let employeeCount = 0;
    let sizeCategory = 'Unknown';
    let hasEmployeeData = false;
    
    // ============================================
    // NORMALIZE CompanyEnrich ranges to ICP ranges
    // ============================================
    const normalizeEmployeeRange = (rangeStr) => {
      if (!rangeStr || typeof rangeStr !== 'string') return null;
      
      const range = rangeStr.toLowerCase().trim();
      
      // CompanyEnrich uses different ranges - normalize them!
      const rangeMap = {
        '1-10': '5-9',           // CompanyEnrich: 1-10 ‚Üí ICP: 5-9
        '11-50': '20-49',        // CompanyEnrich: 11-50 ‚Üí ICP: 20-49
        '51-200': '100-199',     // CompanyEnrich: 51-200 ‚Üí ICP: 100-199 ‚úÖ
        '201-500': '200-499',    // CompanyEnrich: 201-500 ‚Üí ICP: 200-499 ‚úÖ
        '501-1000': '500+',      // CompanyEnrich: 501-1000 ‚Üí ICP: 500+
        '1001-5000': '500+',     // CompanyEnrich: 1001-5000 ‚Üí ICP: 500+
        '5001-10000': '500+',    // CompanyEnrich: 5001-10000 ‚Üí ICP: 500+
        '10000+': '500+',        // CompanyEnrich: 10000+ ‚Üí ICP: 500+
        '10001+': '500+'         // CompanyEnrich: 10001+ ‚Üí ICP: 500+
      };
      
      // Check exact matches first
      if (rangeMap[range]) {
        console.log(`üîÑ Normalized "${rangeStr}" ‚Üí "${rangeMap[range]}"`);
        return rangeMap[range];
      }
      
      // Check if already in ICP format
      const icpRanges = ['1-4', '5-9', '10-19', '20-49', '50-99', '100-199', '200-499', '500+'];
      if (icpRanges.includes(range)) {
        console.log(`‚úÖ Already in ICP format: "${rangeStr}"`);
        return range;
      }
      
      // Try to parse and convert
      const match = range.match(/(\d+)-(\d+)/);
      if (match) {
        const min = parseInt(match[1]);
        const max = parseInt(match[2]);
        
        // Map to ICP ranges based on midpoint
        const midpoint = (min + max) / 2;
        
        if (midpoint < 5) return '1-4';
        else if (midpoint < 10) return '5-9';
        else if (midpoint < 20) return '10-19';
        else if (midpoint < 50) return '20-49';
        else if (midpoint < 100) return '50-99';
        else if (midpoint < 200) return '100-199';
        else if (midpoint < 500) return '200-499';
        else return '500+';
      }
      
      console.warn(`‚ö†Ô∏è Could not normalize range: "${rangeStr}"`);
      return null;
    };
    
    // PRIORITY 1: Use CompanyEnrich employee RANGE (best format)
    if (ceEmployees && ceEmployees !== 'Unknown' && typeof ceEmployees === 'string' && ceEmployees.includes('-')) {
      const normalized = normalizeEmployeeRange(ceEmployees);
      if (normalized) {
        sizeCategory = normalized;
        hasEmployeeData = true;
        console.log('‚úÖ Using CompanyEnrich employee range:', ceEmployees, '‚Üí', sizeCategory);
      }
    }
    // PRIORITY 2: Use CompanyEnrich employee COUNT
    else if (ceEmployees && !isNaN(parseInt(ceEmployees)) && parseInt(ceEmployees) > 1) {
      employeeCount = parseInt(ceEmployees);
      hasEmployeeData = true;
      console.log('‚úÖ Using CompanyEnrich employee count:', employeeCount);
      
      // Convert to range
      if (employeeCount >= 1 && employeeCount <= 4) sizeCategory = '1-4';
      else if (employeeCount >= 5 && employeeCount <= 9) sizeCategory = '5-9';
      else if (employeeCount >= 10 && employeeCount <= 19) sizeCategory = '10-19';
      else if (employeeCount >= 20 && employeeCount <= 49) sizeCategory = '20-49';
      else if (employeeCount >= 50 && employeeCount <= 99) sizeCategory = '50-99';
      else if (employeeCount >= 100 && employeeCount <= 199) sizeCategory = '100-199';
      else if (employeeCount >= 200 && employeeCount <= 499) sizeCategory = '200-499';
      else if (employeeCount >= 500) sizeCategory = '500+';
    }
    // PRIORITY 3: Try Wiza (if available)
    else if (wizaData?.data?.company_size) {
      const wizaEmployees = wizaData.data.company_size;
      const wizaRange = wizaData.data.company_size_range;
      
      if (wizaRange) {
        sizeCategory = wizaRange;
        hasEmployeeData = true;
        console.log('‚úÖ Using Wiza employee range:', sizeCategory);
      } else if (!isNaN(parseInt(wizaEmployees)) && parseInt(wizaEmployees) > 1) {
        employeeCount = parseInt(wizaEmployees);
        hasEmployeeData = true;
        console.log('‚úÖ Using Wiza employee count:', employeeCount);
        
        if (employeeCount >= 1 && employeeCount <= 4) sizeCategory = '1-4';
        else if (employeeCount >= 5 && employeeCount <= 9) sizeCategory = '5-9';
        else if (employeeCount >= 10 && employeeCount <= 19) sizeCategory = '10-19';
        else if (employeeCount >= 20 && employeeCount <= 49) sizeCategory = '20-49';
        else if (employeeCount >= 50 && employeeCount <= 99) sizeCategory = '50-99';
        else if (employeeCount >= 100 && employeeCount <= 199) sizeCategory = '100-199';
        else if (employeeCount >= 200 && employeeCount <= 499) sizeCategory = '200-499';
        else if (employeeCount >= 500) sizeCategory = '500+';
      }
    }
    
    // ============================================
    // IMPROVED Employee Size Estimation
    // ============================================
    if (!hasEmployeeData || sizeCategory === 'Unknown') {
      console.log('‚ö†Ô∏è No employee data - estimating from revenue, funding, and description...');
      
      const description = (ceData?.description || '').toLowerCase();
      let estimatedSize = null;
      
      // STEP 1: Check REVENUE (most reliable indicator)
      if (ceRevenue && !estimatedSize) {
        const revenueLower = ceRevenue.toLowerCase();
        console.log('üí∞ Checking revenue:', ceRevenue);
        
        if (revenueLower.includes('$10b+') || revenueLower.includes('$50b+') || revenueLower.includes('$100b+')) {
          estimatedSize = '500+ (revenue: $10B+)';
          console.log('‚úÖ Revenue ‚Üí 500+');
        } else if (revenueLower.includes('$1b+') || revenueLower.includes('$1b-$10b') || revenueLower.includes('billion')) {
          estimatedSize = '500+ (revenue: $1B+)';
          console.log('‚úÖ Revenue ‚Üí 500+');
        } else if (revenueLower.includes('$500m-$1b') || revenueLower.includes('$100m-$500m')) {
          estimatedSize = '200-499 (revenue: $100M-$1B)';
          console.log('‚úÖ Revenue ‚Üí 200-499');
        } else if (revenueLower.includes('$50m-$100m')) {
          estimatedSize = '100-199 (revenue: $50M-$100M)';
          console.log('‚úÖ Revenue ‚Üí 100-199');
        } else if (revenueLower.includes('$10m-$50m')) {
          estimatedSize = '50-99 (revenue: $10M-$50M)';
          console.log('‚úÖ Revenue ‚Üí 50-99');
        } else if (revenueLower.includes('$1m-$10m')) {
          estimatedSize = '20-49 (revenue: $1M-$10M)';
          console.log('‚úÖ Revenue ‚Üí 20-49');
        }
      }
      
      // STEP 2: Check FUNDING (Series A/B/C/D/E indicators)
      if (!estimatedSize && (ceFunding || ceFundingStage)) {
        const fundingData = ((ceFunding || '') + ' ' + (ceFundingStage || '')).toLowerCase();
        console.log('üíº Checking funding:', fundingData);
        
        if (fundingData.includes('ipo') || fundingData.includes('public')) {
          estimatedSize = '500+ (funding: IPO/Public)';
          console.log('‚úÖ Funding ‚Üí 500+');
        } else if (fundingData.includes('series e') || fundingData.includes('series f')) {
          estimatedSize = '200-499 (funding: Series E+)';
          console.log('‚úÖ Funding ‚Üí 200-499');
        } else if (fundingData.includes('series d')) {
          estimatedSize = '100-199 (funding: Series D)';
          console.log('‚úÖ Funding ‚Üí 100-199');
        } else if (fundingData.includes('series c')) {
          estimatedSize = '50-99 (funding: Series C)';
          console.log('‚úÖ Funding ‚Üí 50-99');
        } else if (fundingData.includes('series b')) {
          estimatedSize = '20-49 (funding: Series B)';
          console.log('‚úÖ Funding ‚Üí 20-49');
        } else if (fundingData.includes('series a')) {
          estimatedSize = '10-19 (funding: Series A)';
          console.log('‚úÖ Funding ‚Üí 10-19');
        }
      }
      
      // STEP 3: Check DESCRIPTION keywords (last resort)
      if (!estimatedSize) {
        console.log('üìù Checking description keywords...');
        
        const sizeIndicators = {
          // Very large (500+)
          'fortune 500': '500+',
          'fortune 1000': '500+',
          'nasdaq-100': '500+',
          's&p 500': '500+',
          'dow jones': '500+',
          'publicly traded': '500+',
          'multinational corporation': '500+',
          'thousands of employees': '500+',
          'trillion-dollar': '500+',
          '100,000+ employees': '500+',
          
          // Large (200-499)
          'global leader': '200-499',
          'international corporation': '200-499',
          'major corporation': '200-499',
          'enterprise company': '200-499',
          '10+ offices worldwide': '200-499',
          'several thousand employees': '200-499',
          
          // Mid-large (100-199)
          'major manufacturer': '100-199',
          'large manufacturer': '100-199',
          'leading international': '100-199',
          'hundreds of employees': '100-199',
          'multiple facilities': '100-199',
          
          // Mid (50-99)
          'leading manufacturer': '50-99',
          'established manufacturer': '50-99',
          'national presence': '50-99',
          'multiple locations': '50-99',
          'growing enterprise': '50-99',
          
          // Small-mid (20-49)
          'medium-sized company': '20-49',
          'established company': '20-49',
          'regional distributor': '20-49',
          'several locations': '20-49',
          
          // Small (10-19)
          'small business': '10-19',
          'growing company': '10-19',
          'local manufacturer': '10-19',
          
          // Very small (5-9)
          'startup': '5-9',
          'small team': '5-9',
          'boutique': '5-9',
          'family business': '5-9',
          'family-owned': '5-9'
        };
        
        for (const [indicator, range] of Object.entries(sizeIndicators)) {
          if (description.includes(indicator)) {
            estimatedSize = `${range} (description: ${indicator})`;
            console.log(`‚úÖ Found "${indicator}" ‚Üí ${range}`);
            break;
          }
        }
      }
      
      // STEP 4: Geographic distribution fallback
      if (!estimatedSize) {
        console.log('üåç Using geographic distribution as fallback...');
        
        if (description.includes('global') || description.includes('worldwide') || description.includes('multinational')) {
          estimatedSize = '200-499 (global distribution)';
        } else if (description.includes('international') || description.includes('across europe')) {
          estimatedSize = '100-199 (international distribution)';
        } else if (description.includes('european') || description.includes('multiple countries')) {
          estimatedSize = '50-99 (european distribution)';
        } else if (description.includes('national') || description.includes('across germany')) {
          estimatedSize = '20-49 (national distribution)';
        } else {
          // FINAL fallback - most common B2B size
          estimatedSize = '20-49 (default estimate)';
          console.log('‚ö†Ô∏è Using default B2B estimate: 20-49');
        }
      }
      
      sizeCategory = estimatedSize;
      console.log(`üìä Final size estimate: ${sizeCategory}`);
    }
    
    // EXACT 67 ICP Industries from ICP Checker
    const icpIndustries = [
      'Surface treatment machinery',
      'Sealing technology',
      'Installation',
      'Machine parts',
      'Wood and wood products',
      'Electrical services',
      'Vehicles',
      'Casting and injection molding machinery',
      'Construction machinery and equipment',
      'Metal and metal products',
      'Valve technology',
      'Pipe and hose technology',
      'Filter and sieve technology',
      'Cable technology',
      'Cleaning supplies',
      'Packaging machinery',
      'Heat treatment',
      'Fluid technology',
      'Electrical engineering',
      'Industrial supplies',
      'Control technology',
      'Surface treatment',
      'Measuring and testing technology',
      'Catering technology and kitchen equipment',
      'Home textiles',
      'Tools and production supplies',
      'Fastening technology, joining technology and fittings',
      'Machining and forming',
      'Sports',
      'Environmental technology',
      'Traffic engineering',
      'Cleaning equipment and machinery',
      'Food technology',
      'Repair, maintenance and modernization',
      'Plastics and plastic products',
      'Robotics, process and automation technology',
      'Conveyor technology',
      'Building materials and supplies',
      'Casting, injection molding and additive manufacturing',
      'Drive technology',
      'Leather, textile fibers, yarns and fabrics',
      'Raw materials and chemistry',
      'Pump technology',
      'Mechanical engineering, plant construction and apparatus construction',
      'Joining and bonding',
      'Containers, logistics and storage supplies',
      'Packaging material',
      'Soldering, welding and bonding technology',
      'Process technology',
      'Office supplies',
      'Refrigeration, air conditioning, ventilation and heating technology',
      'Packaging services',
      'Accumulator and battery technology',
      'Glass and ceramic products',
      'Marking technology',
      'Printing and paper',
      'Safety and rescue technology',
      'Clothing and accessories',
      'Services from agriculture, forestry, fishery, horticulture',
      'Multimedia',
      'Machine tools and equipment',
      'Construction',
      'Lighting technology',
      'Training and education',
      'Food and beverage',
      'Hygiene and cosmetic products',
      'Textile production'
    ];
    
    return fallbackClassification(ceData, wizaData, sizeCategory, ceData?.industry || '', ceData?.description || '', ceData?.location?.country?.name || '', employeeCount, icpIndustries, hasEmployeeData);
  };
  
  const fallbackClassification = (ceData, wizaData, sizeCategory, industry, description, country, employeeCount, icpIndustries, hasEmployeeData) => {
    console.log('üîÑ Using fallback classification with priority order: Industries ‚Üí NAICS ‚Üí Keywords ‚Üí Description');
    
    const descLower = description.toLowerCase();
    
    // Get all available data sources
    const ceIndustries = ceData?.industries || [];
    const ceNaics = ceData?.naics || [];
    const ceKeywords = ceData?.keywords || [];
    
    console.log('üìä Available data sources:', {
      industries: ceIndustries.length,
      naics: ceNaics.length,
      keywords: ceKeywords.length,
      description: description ? 'yes' : 'no'
    });
    
    // Employee size estimation - EXACTLY like ICP Checker
    if (!hasEmployeeData || sizeCategory === 'Unknown') {
      console.log('‚ö†Ô∏è No employee data, estimating from description...');
      
      const sizeIndicators = {
        'startup': '5-9',
        'small team': '5-9',
        'small business': '5-9',
        'boutique': '5-9',
        'family business': '5-9',
        'growing': '10-19',
        'established': '20-49',
        'medium': '20-49',
        'medium-sized': '20-49',
        'leading': '50-99',
        'major': '100-199',
        'large': '100-199',
        'enterprise': '200-499',
        'global leader': '200-499',
        'multinational': '200-499',
        'fortune 500': '500+',
        'thousands of employees': '500+'
      };
      
      let estimatedSize = null;
      
      for (const [indicator, range] of Object.entries(sizeIndicators)) {
        if (descLower.includes(indicator)) {
          estimatedSize = range + ' (estimated)';
          console.log(`‚úÖ Found "${indicator}" ‚Üí estimated ${range}`);
          break;
        }
      }
      
      if (!estimatedSize) {
        if (descLower.includes('global') || descLower.includes('worldwide') || descLower.includes('multinational')) {
          estimatedSize = '100-199 (estimated)';
        } else if (descLower.includes('international')) {
          estimatedSize = '50-99 (estimated)';
        } else if (descLower.includes('europe') || descLower.includes('european')) {
          estimatedSize = '20-49 (estimated)';
        } else if (descLower.includes('national')) {
          estimatedSize = '10-19 (estimated)';
        } else {
          estimatedSize = '10-19 (estimated)';
        }
      }
      
      sizeCategory = estimatedSize;
    }
    
    // INDUSTRY MATCHING - Priority Order (EXACTLY like ICP Checker)
    const matchedIndustries = [];
    let matchSource = '';
    
    // Enhanced keyword mapping - EXACT from ICP Checker
    const industryKeywordMap = {
      'Glass and ceramic products': ['glass', 'glas', 'ceramic', 'keramik', 'schauglas', 'sichtglas', 'glasprodukt', 'glaswaren'],
      'Metal and metal products': ['metal', 'metall', 'steel', 'stahl', 'aluminum', 'aluminium', 'iron', 'eisen'],
      'Valve technology': ['valve', 'ventil', 'armaturen', 'fitting', 'fittings'],
      'Pipe and hose technology': ['pipe', 'rohr', 'hose', 'schlauch', 'rohrleitung', 'tubing'],
      'Electrical engineering': ['electrical', 'elektro', 'electric', 'electronics', 'elektronik'],
      'Control technology': ['control', 'steuerung', 'automation', 'regelung'],
      'Industrial supplies': ['industrial', 'industrie', 'supplies', 'zubeh√∂r', 'industrial supplies'],
      'Measuring and testing technology': ['measuring', 'testing', 'mess', 'pr√ºf', 'level indicator', 'level gauge', 'sensor'],
      'Process technology': ['process', 'prozess'],
      'Mechanical engineering, plant construction and apparatus construction': ['mechanical', 'engineering', 'maschinen', 'anlagen', 'plant engineering', 'apparatus'],
      'Containers, logistics and storage supplies': ['container', 'storage', 'lager', 'beh√§lter', 'storage applications', 'logistics'],
      'Wood and wood products': ['wood', 'holz', 'timber', 'lumber'],
      'Plastics and plastic products': ['plastic', 'kunststoff', 'polymer'],
      'Printing and paper': ['printing', 'druck', 'paper', 'papier'],
      'Food technology': ['food', 'lebensmittel', 'beverage', 'getr√§nke'],
      'Packaging machinery': ['packaging', 'verpackung'],
      'Cleaning supplies': ['cleaning', 'reinigung'],
      'Safety and rescue technology': ['safety', 'sicherheit', 'rescue', 'rettung'],
      'Machine tools and equipment': ['machine tool', 'cnc', 'lathe', 'milling'],
      'Construction machinery and equipment': ['construction', 'bau', 'excavator', 'crane'],
      'Robotics, process and automation technology': ['robot', 'robotics', 'automation', 'automatisierung']
    };
    
    // NAICS to ICP mapping - EXACT from ICP Checker
    const naicsToICP = {
      '3272': 'Glass and ceramic products',
      '327': 'Glass and ceramic products',
      '3332': 'Valve technology',
      '332': 'Metal and metal products',
      '3331': 'Metal and metal products',
      '3261': 'Plastics and plastic products',
      '3259': 'Printing and paper',
      '3221': 'Printing and paper',
      '3339': 'Measuring and testing technology',
      '3345': 'Measuring and testing technology',
      '3353': 'Electrical engineering',
      '335': 'Electrical engineering',
      '3335': 'Control technology',
      '3336': 'Drive technology',
      '3333': 'Construction machinery and equipment',
      '3321': 'Valve technology',
      '3334': 'Heating and cooling equipment',
      '311': 'Food technology',
      '3115': 'Food and beverage',
      '3116': 'Food and beverage',
      '3253': 'Cleaning supplies',
      '3256': 'Textile production',
      '321': 'Wood and wood products'
    };
    
    // PRIORITY 1: Industries (EXACT logic from ICP Checker)
    if (ceIndustries.length > 0) {
      console.log('üéØ PRIORITY 1: Checking Industries from CompanyEnrich:', ceIndustries);
      
      const allIndustriesText = ceIndustries.join(' ').toLowerCase();
      const isServiceBased = allIndustriesText.includes('services') || 
                            allIndustriesText.includes('advertising') ||
                            allIndustriesText.includes('marketing') ||
                            allIndustriesText.includes('software') ||
                            allIndustriesText.includes('data collection') ||
                            allIndustriesText.includes('internet portal');
      
      if (isServiceBased) {
        console.log('‚ö†Ô∏è Service/Platform company detected via Industries - limiting product industry matches');
      }
      
      for (const ceIndustry of ceIndustries) {
        if (matchedIndustries.length >= 5) break;
        
        const ceIndLower = ceIndustry.toLowerCase();
        
        for (const icpInd of icpIndustries) {
          if (matchedIndustries.includes(icpInd)) continue;
          
          const icpLower = icpInd.toLowerCase();
          
          if (isServiceBased) {
            // EXPANDED: Block ALL industrial/product categories for service companies
            const serviceExclusions = [
              'Industrial supplies',
              'Machine parts',
              'Metal and metal products',
              'Electrical engineering',
              'Electronics',
              'Mechanical engineering, plant construction and apparatus construction',
              'Construction machinery and equipment',
              'Machine tools and equipment',
              'Control technology',
              'Measuring and testing technology',
              'Process technology',
              'Drive technology',
              'Pump technology',
              'Valve technology',
              'Pipe and hose technology',
              'Filter and sieve technology',
              'Cable technology',
              'Surface treatment',
              'Surface treatment machinery',
              'Heat treatment',
              'Fluid technology',
              'Sealing technology',
              'Packaging machinery',
              'Conveyor technology',
              'Robotics, process and automation technology',
              'Food technology',
              'Plastics and plastic products',
              'Glass and ceramic products',
              'Wood and wood products',
              'Printing and paper'
            ];
            
            if (serviceExclusions.includes(icpInd)) {
              console.log(`‚ö†Ô∏è Skipping "${icpInd}" - service company detected`);
              continue;
            }
          }
          
          if (ceIndLower.includes(icpLower) || icpLower.includes(ceIndLower)) {
            matchedIndustries.push(icpInd);
            matchSource = 'Industries';
            console.log(`‚úÖ Matched "${icpInd}" via Industries: "${ceIndustry}"`);
            break;
          }
          
          if (industryKeywordMap[icpInd]) {
            for (const keyword of industryKeywordMap[icpInd]) {
              if (isServiceBased && (keyword === 'industrial' || keyword === 'industrie')) {
                continue;
              }
              
              if (ceIndLower.includes(keyword)) {
                matchedIndustries.push(icpInd);
                matchSource = 'Industries';
                console.log(`‚úÖ Matched "${icpInd}" via Industries keyword: "${keyword}" in "${ceIndustry}"`);
                break;
              }
            }
            if (matchedIndustries.includes(icpInd)) break;
          }
        }
      }
    }
    
    // PRIORITY 2: NAICS (EXACT logic from ICP Checker)
    if (matchedIndustries.length < 5 && ceNaics.length > 0) {
      console.log('üéØ PRIORITY 2: Checking NAICS codes from CompanyEnrich:', ceNaics);
      
      for (const naicsObj of ceNaics) {
        if (matchedIndustries.length >= 5) break;
        
        const naicsCode = naicsObj.code || naicsObj;
        const naicsDesc = naicsObj.description || '';
        
        const naicsPrefix = naicsCode.substring(0, 4);
        const naicsPrefix3 = naicsCode.substring(0, 3);
        
        if (naicsToICP[naicsPrefix] && !matchedIndustries.includes(naicsToICP[naicsPrefix])) {
          matchedIndustries.push(naicsToICP[naicsPrefix]);
          matchSource = matchSource || 'NAICS';
          console.log(`‚úÖ Matched "${naicsToICP[naicsPrefix]}" via NAICS code: ${naicsCode}`);
        } else if (naicsToICP[naicsPrefix3] && !matchedIndustries.includes(naicsToICP[naicsPrefix3])) {
          matchedIndustries.push(naicsToICP[naicsPrefix3]);
          matchSource = matchSource || 'NAICS';
          console.log(`‚úÖ Matched "${naicsToICP[naicsPrefix3]}" via NAICS code: ${naicsCode}`);
        }
        
        if (naicsDesc) {
          const naicsDescLower = naicsDesc.toLowerCase();
          
          for (const icpInd of icpIndustries) {
            if (matchedIndustries.length >= 5) break;
            if (matchedIndustries.includes(icpInd)) continue;
            
            if (industryKeywordMap[icpInd]) {
              for (const keyword of industryKeywordMap[icpInd]) {
                if (naicsDescLower.includes(keyword)) {
                  matchedIndustries.push(icpInd);
                  matchSource = matchSource || 'NAICS';
                  console.log(`‚úÖ Matched "${icpInd}" via NAICS description: "${keyword}" in "${naicsDesc}"`);
                  break;
                }
              }
              if (matchedIndustries.includes(icpInd)) break;
            }
          }
        }
      }
    }
    
    // PRIORITY 3: Keywords (EXACT logic from ICP Checker)
    if (matchedIndustries.length < 5 && ceKeywords.length > 0) {
      console.log('üéØ PRIORITY 3: Checking Keywords from CompanyEnrich:', ceKeywords);
      
      const keywordsText = ceKeywords.join(' ').toLowerCase();
      
      const isMarketplace = keywordsText.includes('marketplace') || keywordsText.includes('platform');
      const isAdvertising = keywordsText.includes('advertising') || keywordsText.includes('marketing') || keywordsText.includes('lead generation');
      const isSoftware = keywordsText.includes('software') || keywordsText.includes('saas') || keywordsText.includes('digital');
      
      const isServiceProvider = isMarketplace || isAdvertising || isSoftware;
      
      if (isServiceProvider) {
        console.log('‚ö†Ô∏è Detected service provider indicators - will skip industrial product matches');
      }
      
      for (const icpInd of icpIndustries) {
        if (matchedIndustries.length >= 5) break;
        if (matchedIndustries.includes(icpInd)) continue;
        
        if (isServiceProvider) {
          // EXPANDED: Block ALL industrial/product categories for service companies
          const serviceExclusions = [
            'Industrial supplies',
            'Machine parts',
            'Metal and metal products',
            'Electrical engineering',
            'Electronics',
            'Mechanical engineering, plant construction and apparatus construction',
            'Construction machinery and equipment',
            'Machine tools and equipment',
            'Control technology',
            'Measuring and testing technology',
            'Process technology',
            'Drive technology',
            'Pump technology',
            'Valve technology',
            'Pipe and hose technology',
            'Filter and sieve technology',
            'Cable technology',
            'Surface treatment',
            'Surface treatment machinery',
            'Heat treatment',
            'Fluid technology',
            'Sealing technology',
            'Packaging machinery',
            'Conveyor technology',
            'Robotics, process and automation technology',
            'Food technology',
            'Plastics and plastic products',
            'Glass and ceramic products',
            'Wood and wood products',
            'Printing and paper'
          ];
          
          if (serviceExclusions.includes(icpInd)) {
            console.log(`‚ö†Ô∏è Skipping "${icpInd}" - service provider detected`);
            continue;
          }
        }
        
        if (industryKeywordMap[icpInd]) {
          for (const keyword of industryKeywordMap[icpInd]) {
            if ((keyword === 'industrial' || keyword === 'industrie') && 
                (keywordsText.includes('industrial marketplace') || 
                 keywordsText.includes('industrial platform') ||
                 keywordsText.includes('industrie marktplatz'))) {
              console.log(`‚ö†Ô∏è Skipping "${keyword}" - detected in service context`);
              continue;
            }
            
            if (keywordsText.includes(keyword)) {
              matchedIndustries.push(icpInd);
              matchSource = matchSource || 'Keywords';
              console.log(`‚úÖ Matched "${icpInd}" via Keywords: "${keyword}"`);
              break;
            }
          }
        }
      }
    }
    
    // PRIORITY 4: Description (EXACT logic from ICP Checker)
    if (matchedIndustries.length < 5 && description) {
      console.log('üéØ PRIORITY 4: Checking Description (last resort)');
      
      for (const icpInd of icpIndustries) {
        if (matchedIndustries.length >= 5) break;
        if (matchedIndustries.includes(icpInd)) continue;
        
        const icpLower = icpInd.toLowerCase();
        
        if (descLower.includes(icpLower)) {
          matchedIndustries.push(icpInd);
          matchSource = matchSource || 'Description';
          console.log(`‚úÖ Matched "${icpInd}" via Description: direct match`);
          continue;
        }
        
        if (industryKeywordMap[icpInd]) {
          for (const keyword of industryKeywordMap[icpInd]) {
            if (descLower.includes(keyword)) {
              matchedIndustries.push(icpInd);
              matchSource = matchSource || 'Description';
              console.log(`‚úÖ Matched "${icpInd}" via Description keyword: "${keyword}"`);
              break;
            }
          }
        }
      }
    }
    
    const finalIndustry = matchedIndustries.length > 0 
      ? matchedIndustries.join('; ')
      : (industry ? `Other: ${industry}` : 'Unknown');
    
    console.log(`üéØ Final industry classification: ${finalIndustry} (Source: ${matchSource || 'None'})`);

    // Supplier Type Classification - EXACT from ICP Checker
    const supplierTypes = [];
    
    if (descLower.includes('manufactur') || descLower.includes('production')) {
      if (descLower.includes('custom')) {
        supplierTypes.push('Customer Specific Manufacturing');
      } else {
        supplierTypes.push('Manufacturer');
      }
    }
    
    if (descLower.includes('distribut')) supplierTypes.push('Distributor');
    if (descLower.includes('wholesal')) supplierTypes.push('Wholesaler');
    if (descLower.includes('service') || descLower.includes('consulting')) {
      supplierTypes.push('Service Provider');
    }
    
    if (supplierTypes.length === 0) supplierTypes.push('Service Provider');
    
    const finalSupplierType = supplierTypes.join('; ');

    // Distribution Area - EXACT from ICP Checker
    let distArea = 'Regional';
    
    if (descLower.includes('global') || descLower.includes('worldwide')) {
      distArea = 'International';
    } else if (descLower.includes('europe') || descLower.includes('european')) {
      distArea = 'European';
    } else if (descLower.includes('national') || employeeCount > 100) {
      distArea = 'National';
    }

    // ICP Validation - EXACT from ICP Checker
    const reasons = [];
    let isICP = true;

    const actualSizeCategory = sizeCategory.replace(' (estimated)', '');
    const icpSizes = ['5-9', '10-19', '20-49', '50-99', '100-199', '200-499'];
    
    if (!icpSizes.includes(actualSizeCategory)) {
      if (actualSizeCategory !== 'Unknown') {
        isICP = false;
        reasons.push(`‚úó Size ${sizeCategory} outside ICP range`);
      }
    } else {
      reasons.push(`‚úì ICP size: ${sizeCategory}`);
    }

    if (matchedIndustries.length === 0) {
      isICP = false;
      reasons.push(`‚úó Industry not in ICP list`);
    } else {
      reasons.push(`‚úì Industry match`);
    }
    
    return {
      industry: finalIndustry,
      supplier_type: finalSupplierType,
      distribution_area: distArea,
      employees: sizeCategory,
      icp_match: isICP,
      reason: reasons.join(' | ')
    };
  };
  
  const exportClassifiedToCSV = () => {
    if (classifiedCompanies.length === 0) {
      showToast('No classified companies to export', 'warning');
      return;
    }
    
    const headers = [
      'Name', 'Domain', 'Website', 'ICP Match', 'Industry', 'Supplier Type',
      'Distribution Area', 'Employees', 'Reason', 'Country', 'Description'
    ];
    
    const rows = classifiedCompanies.map(company => [
      company.name || '',
      company.domain || '',
      company.website || '',
      company.icp_classification.icp_match ? 'YES' : 'NO',
      company.icp_classification.industry,
      company.icp_classification.supplier_type,
      company.icp_classification.distribution_area,
      company.icp_classification.employees,
      company.icp_classification.reason,
      company.location?.country?.name || '',
      (company.description || '').replace(/"/g, '""')
    ]);
    
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `icp_classified_${Date.now()}.csv`;
    a.click();
    
    const icpCount = classifiedCompanies.filter(c => c.icp_classification.icp_match).length;
    showToast(`Exported ${classifiedCompanies.length} companies (${icpCount} ICP matches)`, 'success');
  };
  
  const revealContactsForICPCompanies = async () => {
    const icpCompanies = classifiedCompanies.filter(c => c.icp_classification.icp_match);
    
    if (icpCompanies.length === 0) {
      showToast('No ICP-matching companies found', 'warning');
      return;
    }
    
    if (!confirm(`Reveal contacts for ${icpCompanies.length} ICP-matching companies?\n\nThis will cost Wiza credits.`)) {
      return;
    }
    
    setRevealingContacts(true);
    setRevealProgress('');
    const companiesWithNewContacts = [];
    
    try {
      for (let i = 0; i < icpCompanies.length; i++) {
        const company = icpCompanies[i];
        setRevealProgress(`Searching contacts ${i + 1}/${icpCompanies.length}: ${company.name}...`);
        
        try {
          // Search for employees
          const searchResponse = await fetch('https://wiza-proxy.onrender.com/api/wiza/search-employee', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              company_domain: company.domain,
              seniority: ['owner', 'c_suite', 'partner', 'vp', 'director', 'manager'],
              page_size: 5
            })
          });
          
          if (!searchResponse.ok) {
            console.warn('Employee search failed for', company.domain);
            companiesWithNewContacts.push({
              ...company,
              contacts: [],
              contactError: 'Search failed'
            });
            continue;
          }
          
          const searchData = await searchResponse.json();
          console.log('Search results for', company.domain, searchData);
          
          if (!searchData.data?.matches || searchData.data.matches.length === 0) {
            companiesWithNewContacts.push({
              ...company,
              contacts: [],
              contactError: 'No contacts found'
            });
            continue;
          }
          
          // Get first 5 contacts
          const contacts = searchData.data.matches.slice(0, 5).map(match => ({
            id: match.id,
            firstName: match.first_name,
            lastName: match.last_name,
            fullName: match.full_name,
            title: match.title,
            seniority: match.seniority,
            email: null, // Will be revealed on demand
            phone: null,
            revealed: false
          }));
          
          companiesWithNewContacts.push({
            ...company,
            contacts: contacts,
            contactError: null
          });
          
        } catch (err) {
          console.error('Error searching contacts for', company.domain, err);
          companiesWithNewContacts.push({
            ...company,
            contacts: [],
            contactError: err.message
          });
        }
        
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      setCompaniesWithContacts(companiesWithNewContacts);
      setRevealProgress('');
      setShowContactsList(true);
      
      const totalContacts = companiesWithNewContacts.reduce((sum, c) => sum + (c.contacts?.length || 0), 0);
      showToast(`Found ${totalContacts} contacts across ${companiesWithNewContacts.length} companies! Select which to reveal.`, 'success');
      
    } catch (err) {
      console.error('Contact reveal error:', err);
      showToast(`Contact search failed: ${err.message}`, 'error');
    } finally {
      setRevealingContacts(false);
    }
  };
  
  const toggleContactSelection = (companyDomain, contactId) => {
    const key = `${companyDomain}|${contactId}`;
    setSelectedContacts(prev => {
      if (prev.includes(key)) {
        return prev.filter(k => k !== key);
      } else {
        return [...prev, key];
      }
    });
  };
  
  const isContactSelected = (companyDomain, contactId) => {
    return selectedContacts.includes(`${companyDomain}|${contactId}`);
  };
  
  const revealSelectedContacts = async () => {
    if (selectedContacts.length === 0) {
      showToast('Please select at least one contact', 'warning');
      return;
    }
    
    if (!confirm(`Reveal ${selectedContacts.length} contacts?\n\nThis will cost Wiza credits.`)) {
      return;
    }
    
    setRevealingContacts(true);
    setRevealProgress('');
    
    try {
      let revealedCount = 0;
      
      for (let i = 0; i < selectedContacts.length; i++) {
        const [domain, contactId] = selectedContacts[i].split('|');
        setRevealProgress(`Revealing ${i + 1}/${selectedContacts.length}...`);
        
        try {
          const revealResponse = await fetch('https://wiza-proxy.onrender.com/api/wiza/reveal-employee', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contact_id: contactId
            })
          });
          
          if (revealResponse.ok) {
            const revealData = await revealResponse.json();
            
            // Update the contact in companiesWithContacts
            setCompaniesWithContacts(prev => prev.map(company => {
              if (company.domain === domain) {
                return {
                  ...company,
                  contacts: company.contacts.map(contact => {
                    if (contact.id === contactId) {
                      return {
                        ...contact,
                        email: revealData.data?.email,
                        phone: revealData.data?.phone_number,
                        revealed: true
                      };
                    }
                    return contact;
                  })
                };
              }
              return company;
            }));
            
            revealedCount++;
          }
          
        } catch (err) {
          console.error('Error revealing contact', contactId, err);
        }
        
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      setRevealProgress('');
      showToast(`Successfully revealed ${revealedCount} contacts!`, 'success');
      
    } catch (err) {
      console.error('Reveal error:', err);
      showToast(`Reveal failed: ${err.message}`, 'error');
    } finally {
      setRevealingContacts(false);
    }
  };
  
  const exportContactsToCSV = () => {
    const revealedContacts = [];
    
    companiesWithContacts.forEach(company => {
      company.contacts?.forEach(contact => {
        if (contact.revealed) {
          revealedContacts.push({
            companyName: company.name,
            companyDomain: company.domain,
            industry: company.icp_classification.industry,
            firstName: contact.firstName,
            lastName: contact.lastName,
            title: contact.title,
            seniority: contact.seniority,
            email: contact.email,
            phone: contact.phone
          });
        }
      });
    });
    
    if (revealedContacts.length === 0) {
      showToast('No revealed contacts to export', 'warning');
      return;
    }
    
    const headers = [
      'Company Name', 'Domain', 'Industry', 'First Name', 'Last Name',
      'Title', 'Seniority', 'Email', 'Phone'
    ];
    
    const rows = revealedContacts.map(c => [
      c.companyName, c.companyDomain, c.industry, c.firstName, c.lastName,
      c.title, c.seniority, c.email, c.phone
    ]);
    
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${cell || ''}"`).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `revealed_contacts_${Date.now()}.csv`;
    a.click();
    
    showToast(`Exported ${revealedContacts.length} revealed contacts!`, 'success');
  };

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#f9fafb', padding: '24px' }}>
      <style>
        {`
          @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
          }
          @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
          }
        `}
      </style>
      
      {/* Toast Notifications */}
      <div style={{
        position: 'fixed',
        top: '24px',
        right: '24px',
        zIndex: 9999,
        display: 'flex',
        flexDirection: 'column',
        gap: '12px',
        maxWidth: '400px'
      }}>
        {toasts.map(toast => (
          <div
            key={toast.id}
            style={{
              background: toast.type === 'success' ? '#10b981' :
                         toast.type === 'error' ? '#ef4444' :
                         toast.type === 'warning' ? '#f59e0b' : '#3b82f6',
              color: 'white',
              padding: '16px 20px',
              borderRadius: '12px',
              boxShadow: '0 10px 25px rgba(0,0,0,0.2)',
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              animation: 'slideIn 0.3s ease-out',
              cursor: 'pointer'
            }}
            onClick={() => removeToast(toast.id)}
          >
            <span style={{ fontSize: '20px' }}>
              {toast.type === 'success' ? '‚úÖ' :
               toast.type === 'error' ? '‚ùå' :
               toast.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
            </span>
            <span style={{ flex: 1, fontSize: '14px', fontWeight: '500' }}>
              {toast.message}
            </span>
            <span style={{ fontSize: '18px', opacity: 0.7 }}>√ó</span>
          </div>
        ))}
      </div>
      
      <div style={{ maxWidth: '1400px', margin: '0 auto' }}>
        {/* Header */}
        <div style={{ textAlign: 'center', marginBottom: '32px' }}>
          <svg width="200" height="60" viewBox="0 0 200 60" style={{ height: '40px', marginBottom: '16px' }}>
            <text x="10" y="40" fill={visableNavy} fontSize="32" fontWeight="bold" fontFamily="Arial, sans-serif">
              visable
            </text>
            <circle cx="12" cy="15" r="6" fill={visableGreen} />
          </svg>
          <h1 style={{ fontSize: '32px', fontWeight: 'bold', color: '#111827', marginBottom: '8px' }}>
            Company Search
          </h1>
          <p style={{ fontSize: '16px', color: '#6b7280', marginBottom: '16px' }}>
            Find companies using AI-powered semantic search and advanced filters
          </p>
          <button
            onClick={() => setShowSavedLists(!showSavedLists)}
            style={{
              padding: '10px 20px',
              backgroundColor: visableNavy,
              color: 'white',
              border: 'none',
              borderRadius: '8px',
              fontSize: '14px',
              fontWeight: '600',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              margin: '0 auto'
            }}
          >
            üìã My Lists ({savedLists.length})
          </button>
        </div>

        {/* Search Box */}
        <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', marginBottom: '24px' }}>
          <div style={{ marginBottom: '16px' }}>
            <label style={{ display: 'block', fontSize: '14px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
              ü§ñ Semantic Search (Natural Language)
            </label>
            <div style={{ display: 'flex', gap: '12px' }}>
              <div style={{ flex: 1, position: 'relative' }}>
                <Search style={{
                  position: 'absolute',
                  left: '12px',
                  top: '50%',
                  transform: 'translateY(-50%)',
                  color: '#9ca3af',
                  width: '20px',
                  height: '20px'
                }} />
                <input
                  type="text"
                  value={semanticQuery}
                  onChange={(e) => setSemanticQuery(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleSearch(1)}
                  placeholder="e.g., AI companies in Germany with 50-200 employees"
                  style={{
                    width: '100%',
                    paddingLeft: '40px',
                    paddingRight: '12px',
                    paddingTop: '12px',
                    paddingBottom: '12px',
                    border: '2px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px'
                  }}
                />
              </div>
              <button
                onClick={() => handleSearch(1)}
                disabled={isSearching}
                style={{
                  padding: '12px 24px',
                  backgroundColor: isSearching ? '#d1d5db' : visableGreen,
                  color: 'white',
                  borderRadius: '8px',
                  fontWeight: '600',
                  border: 'none',
                  cursor: isSearching ? 'not-allowed' : 'pointer',
                  fontSize: '14px',
                  whiteSpace: 'nowrap'
                }}
              >
                {isSearching ? 'Searching...' : 'Search'}
              </button>
            </div>
          </div>

          {/* Filters Toggle */}
          <button
            onClick={() => setShowFilters(!showFilters)}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              padding: '8px 16px',
              backgroundColor: '#f3f4f6',
              border: '1px solid #e5e7eb',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: '500'
            }}
          >
            <Filter style={{ width: '16px', height: '16px' }} />
            Advanced Filters
            <ChevronDown style={{ width: '16px', height: '16px', transform: showFilters ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s' }} />
            {(countries.length + employeeRanges.length + revenueRanges.length) > 0 && (
              <span style={{ marginLeft: '4px', padding: '2px 8px', backgroundColor: visableGreen, color: 'white', borderRadius: '12px', fontSize: '12px' }}>
                {countries.length + employeeRanges.length + revenueRanges.length}
              </span>
            )}
          </button>

          {/* Filters Panel */}
          {showFilters && (
            <div style={{ marginTop: '16px', padding: '16px', backgroundColor: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                <h3 style={{ fontSize: '16px', fontWeight: '600', color: '#111827' }}>Filters</h3>
                <button
                  onClick={clearFilters}
                  style={{
                    padding: '4px 12px',
                    backgroundColor: 'white',
                    border: '1px solid #e5e7eb',
                    borderRadius: '6px',
                    fontSize: '12px',
                    cursor: 'pointer'
                  }}
                >
                  Clear All
                </button>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                {/* Countries */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
                    Countries
                  </label>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                    {countryOptions.map(country => (
                      <button
                        key={country.code}
                        onClick={() => toggleCountry(country.code)}
                        style={{
                          padding: '6px 12px',
                          backgroundColor: countries.includes(country.code) ? visableGreen : 'white',
                          color: countries.includes(country.code) ? 'white' : '#374151',
                          border: `1px solid ${countries.includes(country.code) ? visableGreen : '#e5e7eb'}`,
                          borderRadius: '6px',
                          fontSize: '12px',
                          cursor: 'pointer',
                          fontWeight: countries.includes(country.code) ? '600' : 'normal'
                        }}
                      >
                        {country.name}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Employee Ranges */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
                    Employee Size
                  </label>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                    {employeeOptions.map(range => (
                      <button
                        key={range}
                        onClick={() => toggleEmployeeRange(range)}
                        style={{
                          padding: '6px 12px',
                          backgroundColor: employeeRanges.includes(range) ? visableGreen : 'white',
                          color: employeeRanges.includes(range) ? 'white' : '#374151',
                          border: `1px solid ${employeeRanges.includes(range) ? visableGreen : '#e5e7eb'}`,
                          borderRadius: '6px',
                          fontSize: '12px',
                          cursor: 'pointer',
                          fontWeight: employeeRanges.includes(range) ? '600' : 'normal'
                        }}
                      >
                        {range}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Revenue Ranges */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
                    Revenue
                  </label>
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                    {revenueOptions.map(range => (
                      <button
                        key={range}
                        onClick={() => toggleRevenueRange(range)}
                        style={{
                          padding: '6px 12px',
                          backgroundColor: revenueRanges.includes(range) ? visableGreen : 'white',
                          color: revenueRanges.includes(range) ? 'white' : '#374151',
                          border: `1px solid ${revenueRanges.includes(range) ? visableGreen : '#e5e7eb'}`,
                          borderRadius: '6px',
                          fontSize: '12px',
                          cursor: 'pointer',
                          fontWeight: revenueRanges.includes(range) ? '600' : 'normal'
                        }}
                      >
                        {range}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Founded Year */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
                    Founded Year
                  </label>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    <input
                      type="number"
                      value={foundedYearMin}
                      onChange={(e) => setFoundedYearMin(e.target.value)}
                      placeholder="Min"
                      style={{
                        flex: 1,
                        padding: '6px 12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '6px',
                        fontSize: '12px'
                      }}
                    />
                    <input
                      type="number"
                      value={foundedYearMax}
                      onChange={(e) => setFoundedYearMax(e.target.value)}
                      placeholder="Max"
                      style={{
                        flex: 1,
                        padding: '6px 12px',
                        border: '1px solid #e5e7eb',
                        borderRadius: '6px',
                        fontSize: '12px'
                      }}
                    />
                  </div>
                </div>

                {/* Keywords */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
                    Keywords (comma-separated)
                  </label>
                  <input
                    type="text"
                    value={keywords}
                    onChange={(e) => setKeywords(e.target.value)}
                    placeholder="e.g., software, AI, cloud"
                    style={{
                      width: '100%',
                      padding: '6px 12px',
                      border: '1px solid #e5e7eb',
                      borderRadius: '6px',
                      fontSize: '12px'
                    }}
                  />
                </div>

                {/* Technologies */}
                <div>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
                    Technologies (comma-separated)
                  </label>
                  <input
                    type="text"
                    value={technologies}
                    onChange={(e) => setTechnologies(e.target.value)}
                    placeholder="e.g., React, Python, AWS"
                    style={{
                      width: '100%',
                      padding: '6px 12px',
                      border: '1px solid #e5e7eb',
                      borderRadius: '6px',
                      fontSize: '12px'
                    }}
                  />
                </div>

                {/* NAICS Codes */}
                <div style={{ gridColumn: 'span 2' }}>
                  <label style={{ display: 'block', fontSize: '13px', fontWeight: '600', color: '#374151', marginBottom: '8px' }}>
                    NAICS Codes (comma-separated, 2-6 digits)
                  </label>
                  <input
                    type="text"
                    value={naicsCodes}
                    onChange={(e) => setNaicsCodes(e.target.value)}
                    placeholder="e.g., 3272, 5112, 541"
                    style={{
                      width: '100%',
                      padding: '6px 12px',
                      border: '1px solid #e5e7eb',
                      borderRadius: '6px',
                      fontSize: '12px'
                    }}
                  />
                </div>
              </div>
            </div>
          )}

          {error && (
            <div style={{
              marginTop: '16px',
              padding: '12px',
              backgroundColor: '#fef2f2',
              border: '1px solid #fecaca',
              borderRadius: '8px',
              color: '#991b1b',
              fontSize: '13px'
            }}>
              {error}
            </div>
          )}
        </div>

        {/* Results Header */}
        {results.length > 0 && (
          <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '16px 24px', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', marginBottom: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <div>
              <h2 style={{ fontSize: '20px', fontWeight: '600', color: '#111827' }}>
                {totalResults.toLocaleString()} Companies Found
              </h2>
              <p style={{ fontSize: '13px', color: '#6b7280', marginTop: '4px' }}>
                Showing {results.length} results ‚Ä¢ {selectedCompanies.length} selected
              </p>
            </div>
            <div style={{ display: 'flex', gap: '12px' }}>
              {selectedCompanies.length > 0 && (
                <button
                  onClick={() => setShowSelectedList(!showSelectedList)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '10px 20px',
                    backgroundColor: visableNavy,
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  View Selected ({selectedCompanies.length})
                </button>
              )}
              <button
                onClick={exportToCSV}
                style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  padding: '10px 20px',
                  backgroundColor: visableGreen,
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
              >
                <Download style={{ width: '16px', height: '16px' }} />
                Export CSV
              </button>
            </div>
          </div>
        )}

        {/* Results Grid */}
        {results.length > 0 && (
          <div style={{
            maxHeight: '70vh',
            overflowY: 'auto',
            paddingRight: '8px',
            marginBottom: '24px'
          }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(400px, 1fr))', gap: '16px' }}>
            {results.map((company, idx) => (
              <div 
                key={idx} 
                onClick={() => toggleCompanySelection(company)}
                style={{ 
                  backgroundColor: 'white', 
                  borderRadius: '12px', 
                  padding: '20px', 
                  boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)',
                  border: isCompanySelected(company) ? `3px solid ${visableGreen}` : '3px solid transparent',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
              >
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px' }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                      <input
                        type="checkbox"
                        checked={isCompanySelected(company)}
                        onChange={(e) => {
                          e.stopPropagation();
                          toggleCompanySelection(company);
                        }}
                        onClick={(e) => e.stopPropagation()}
                        style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                      />
                      <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>
                        {company.name || 'Unknown Company'}
                      </h3>
                    </div>
                    {company.website && (
                      <a 
                        href={company.website} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        onClick={(e) => e.stopPropagation()}
                        style={{
                          fontSize: '13px', color: '#3b82f6', textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '4px', marginLeft: '26px'
                        }}
                      >
                        {company.domain}
                        <ExternalLink style={{ width: '12px', height: '12px' }} />
                      </a>
                    )}
                  </div>
                </div>

                {company.description && (
                  <p style={{ fontSize: '13px', color: '#6b7280', lineHeight: '1.5', marginBottom: '12px' }}>
                    {company.description.substring(0, 150)}{company.description.length > 150 ? '...' : ''}
                  </p>
                )}

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '12px' }}>
                  {company.industry && (
                    <div style={{ padding: '8px', backgroundColor: '#f0fdf4', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#166534', fontWeight: '600' }}>Industry</div>
                      <div style={{ fontSize: '12px', color: '#166534' }}>{company.industry}</div>
                    </div>
                  )}

                  {company.employees && (
                    <div style={{ padding: '8px', backgroundColor: '#eff6ff', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#1e40af', fontWeight: '600' }}>Employees</div>
                      <div style={{ fontSize: '12px', color: '#1e40af' }}>{company.employees}</div>
                    </div>
                  )}

                  {company.revenue && (
                    <div style={{ padding: '8px', backgroundColor: '#fef3c7', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#92400e', fontWeight: '600' }}>Revenue</div>
                      <div style={{ fontSize: '12px', color: '#92400e' }}>{company.revenue}</div>
                    </div>
                  )}

                  {company.location?.country?.name && (
                    <div style={{ padding: '8px', backgroundColor: '#f3e8ff', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#6b21a8', fontWeight: '600' }}>Country</div>
                      <div style={{ fontSize: '12px', color: '#6b21a8' }}>{company.location.country.name}</div>
                    </div>
                  )}
                </div>

                {company.keywords && company.keywords.length > 0 && (
                  <div style={{ display: 'flex', flexWrap: 'wrap', gap: '4px' }}>
                    {company.keywords.slice(0, 5).map((keyword, kidx) => (
                      <span key={kidx} style={{
                        padding: '2px 8px',
                        backgroundColor: '#f3f4f6',
                        color: '#374151',
                        borderRadius: '4px',
                        fontSize: '11px'
                      }}>
                        {keyword}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
          </div>
        )}

        {/* Load More */}
        {results.length > 0 && results.length < totalResults && (
          <div style={{ textAlign: 'center', marginBottom: '24px' }}>
            <button
              onClick={handleLoadMore}
              disabled={isSearching}
              style={{
                padding: '12px 32px',
                backgroundColor: isSearching ? '#d1d5db' : visableGreen,
                color: 'white',
                border: 'none',
                borderRadius: '8px',
                fontSize: '14px',
                fontWeight: '600',
                cursor: isSearching ? 'not-allowed' : 'pointer'
              }}
            >
              {isSearching ? 'Loading...' : `Load More (${results.length} of ${totalResults})`}
            </button>
          </div>
        )}

        {/* Selected Companies List */}
        {showSelectedList && selectedCompanies.length > 0 && (
          <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', marginBottom: '24px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <div>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#111827' }}>
                  Selected Companies ({selectedCompanies.length})
                </h2>
                <p style={{ fontSize: '13px', color: '#6b7280', marginTop: '4px' }}>
                  Save this list to run ICP classification later
                </p>
              </div>
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={clearSelectedCompanies}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: 'white',
                    color: '#374151',
                    border: '2px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  Clear All
                </button>
                <button
                  onClick={saveListDialog}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: visableGreen,
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  üíæ Save List
                </button>
                <button
                  onClick={() => setShowSelectedList(false)}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: 'white',
                    color: '#374151',
                    border: '2px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  Close
                </button>
              </div>
            </div>

            {classificationProgress && (
              <div style={{
                padding: '16px',
                backgroundColor: '#eff6ff',
                borderRadius: '12px',
                marginBottom: '20px',
                border: '2px solid #3b82f6'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <Loader style={{ width: '24px', height: '24px', color: '#3b82f6', animation: 'spin 1s linear infinite' }} />
                  <div style={{ color: '#1e40af', fontSize: '14px', fontWeight: '600' }}>
                    {classificationProgress}
                  </div>
                </div>
              </div>
            )}

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(350px, 1fr))', gap: '12px' }}>
              {selectedCompanies.map((company, idx) => (
                <div key={idx} style={{
                  padding: '12px 16px',
                  backgroundColor: '#f9fafb',
                  borderRadius: '8px',
                  border: '1px solid #e5e7eb',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center'
                }}>
                  <div>
                    <div style={{ fontSize: '14px', fontWeight: '600', color: '#111827' }}>
                      {company.name}
                    </div>
                    <div style={{ fontSize: '12px', color: '#6b7280' }}>
                      {company.domain}
                    </div>
                  </div>
                  <button
                    onClick={() => toggleCompanySelection(company)}
                    style={{
                      padding: '4px 8px',
                      backgroundColor: 'white',
                      border: '1px solid #e5e7eb',
                      borderRadius: '6px',
                      fontSize: '12px',
                      cursor: 'pointer'
                    }}
                  >
                    <X style={{ width: '14px', height: '14px' }} />
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Save List Dialog */}
        {showSaveDialog && (
          <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 }}>
            <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '24px', maxWidth: '500px', width: '90%' }}>
              <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#111827', marginBottom: '16px' }}>
                Save Company List
              </h2>
              <p style={{ fontSize: '14px', color: '#6b7280', marginBottom: '16px' }}>
                Give your list a name. You can run ICP classification on it later from "My Lists".
              </p>
              <input
                type="text"
                value={listName}
                onChange={(e) => setListName(e.target.value)}
                placeholder="e.g., German Manufacturers Q4 2024"
                style={{
                  width: '100%',
                  padding: '12px',
                  border: '2px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  marginBottom: '20px',
                  boxSizing: 'border-box'
                }}
                onKeyPress={(e) => e.key === 'Enter' && saveList()}
              />
              <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                <button
                  onClick={() => { setShowSaveDialog(false); setListName(''); }}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: 'white',
                    color: '#374151',
                    border: '2px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={saveList}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: visableGreen,
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  Save List
                </button>
              </div>
            </div>
          </div>
        )}

        {/* My Lists Panel */}
        {showSavedLists && (
          <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', marginBottom: '24px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <div>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#111827' }}>
                  My Saved Lists ({savedLists.length})
                </h2>
                <p style={{ fontSize: '13px', color: '#6b7280', marginTop: '4px' }}>
                  Run ICP classification on your saved company lists
                </p>
              </div>
              <button
                onClick={() => setShowSavedLists(false)}
                style={{
                  padding: '10px 20px',
                  backgroundColor: 'white',
                  color: '#374151',
                  border: '2px solid #e5e7eb',
                  borderRadius: '8px',
                  fontSize: '14px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
              >
                Close
              </button>
            </div>

            {savedLists.length === 0 ? (
              <div style={{ textAlign: 'center', padding: '48px', backgroundColor: '#f9fafb', borderRadius: '8px' }}>
                <p style={{ fontSize: '16px', color: '#6b7280', marginBottom: '8px' }}>
                  No saved lists yet
                </p>
                <p style={{ fontSize: '14px', color: '#9ca3af' }}>
                  Select companies from search results and save them as a list
                </p>
              </div>
            ) : (
              <div style={{ display: 'grid', gap: '16px' }}>
                {savedLists.map((list) => (
                  <div key={list.id} style={{
                    padding: '20px',
                    backgroundColor: '#f9fafb',
                    borderRadius: '12px',
                    border: '2px solid #e5e7eb'
                  }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px' }}>
                      <div style={{ flex: 1 }}>
                        <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '4px' }}>
                          {list.name}
                        </h3>
                        <p style={{ fontSize: '13px', color: '#6b7280' }}>
                          {list.companyCount} companies ‚Ä¢ Created {new Date(list.createdAt).toLocaleDateString()}
                        </p>
                        {list.classified && (
                          <p style={{ fontSize: '13px', color: visableGreen, fontWeight: '600', marginTop: '4px' }}>
                            ‚úÖ Classified on {new Date(list.classifiedAt).toLocaleDateString()}
                          </p>
                        )}
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        {list.classified ? (
                          <button
                            onClick={() => viewListResults(list)}
                            style={{
                              padding: '8px 16px',
                              backgroundColor: visableNavy,
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '600',
                              cursor: 'pointer'
                            }}
                          >
                            View Results
                          </button>
                        ) : (
                          <button
                            onClick={() => runICPClassificationOnList(list)}
                            disabled={isClassifying}
                            style={{
                              padding: '8px 16px',
                              backgroundColor: isClassifying && currentClassifyingList?.id === list.id ? '#d1d5db' : visableGreen,
                              color: 'white',
                              border: 'none',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: '600',
                              cursor: isClassifying ? 'not-allowed' : 'pointer'
                            }}
                          >
                            {isClassifying && currentClassifyingList?.id === list.id ? 'Classifying...' : 'üéØ Run ICP'}
                          </button>
                        )}
                        <button
                          onClick={() => deleteList(list.id)}
                          style={{
                            padding: '8px 16px',
                            backgroundColor: 'white',
                            color: '#ef4444',
                            border: '1px solid #e5e7eb',
                            borderRadius: '6px',
                            fontSize: '13px',
                            fontWeight: '600',
                            cursor: 'pointer'
                          }}
                        >
                          Delete
                        </button>
                      </div>
                    </div>

                    {isClassifying && currentClassifyingList?.id === list.id && classificationProgress && (
                      <div style={{
                        padding: '12px',
                        backgroundColor: '#eff6ff',
                        borderRadius: '8px',
                        marginTop: '12px',
                        border: '2px solid #3b82f6'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                          <Loader style={{ width: '20px', height: '20px', color: '#3b82f6', animation: 'spin 1s linear infinite' }} />
                          <div style={{ color: '#1e40af', fontSize: '13px', fontWeight: '600' }}>
                            {classificationProgress}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Show company preview */}
                    <div style={{ marginTop: '12px', display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                      {list.companies.slice(0, 5).map((company, idx) => (
                        <span key={idx} style={{
                          padding: '4px 12px',
                          backgroundColor: 'white',
                          border: '1px solid #e5e7eb',
                          borderRadius: '6px',
                          fontSize: '12px',
                          color: '#374151'
                        }}>
                          {company.name}
                        </span>
                      ))}
                      {list.companies.length > 5 && (
                        <span style={{
                          padding: '4px 12px',
                          backgroundColor: 'white',
                          border: '1px solid #e5e7eb',
                          borderRadius: '6px',
                          fontSize: '12px',
                          color: '#6b7280',
                          fontWeight: '600'
                        }}>
                          +{list.companies.length - 5} more
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Classified Results */}
        {classifiedCompanies.length > 0 && (
          <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', marginBottom: '24px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <div>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#111827' }}>
                  ICP Classification Results
                </h2>
                <p style={{ fontSize: '13px', color: '#6b7280', marginTop: '4px' }}>
                  {classifiedCompanies.filter(c => c.icp_classification.icp_match).length} ICP matches out of {classifiedCompanies.length} companies
                </p>
              </div>
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={revealContactsForICPCompanies}
                  disabled={revealingContacts}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '10px 20px',
                    backgroundColor: revealingContacts ? '#d1d5db' : visableOrange,
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: revealingContacts ? 'not-allowed' : 'pointer'
                  }}
                >
                  {revealingContacts ? 'üîç Searching...' : 'üë§ Reveal Contacts'}
                </button>
                <button
                  onClick={exportClassifiedToCSV}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '10px 20px',
                    backgroundColor: visableGreen,
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  <Download style={{ width: '16px', height: '16px' }} />
                  Export Classified CSV
                </button>
              </div>
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(400px, 1fr))', gap: '16px' }}>
              {classifiedCompanies.map((company, idx) => (
                <div key={idx} style={{
                  backgroundColor: company.icp_classification.icp_match ? '#dcfce7' : '#fef2f2',
                  borderRadius: '12px',
                  padding: '20px',
                  border: `2px solid ${company.icp_classification.icp_match ? visableGreen : '#ef4444'}`
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px' }}>
                    <div style={{ flex: 1 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                        {company.icp_classification.icp_match ? (
                          <span style={{ fontSize: '20px' }}>‚úÖ</span>
                        ) : (
                          <span style={{ fontSize: '20px' }}>‚ùå</span>
                        )}
                        <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827' }}>
                          {company.name}
                        </h3>
                      </div>
                      <a href={company.website} target="_blank" rel="noopener noreferrer" style={{
                        fontSize: '13px', color: '#3b82f6', textDecoration: 'none', display: 'flex', alignItems: 'center', gap: '4px', marginLeft: '28px'
                      }}>
                        {company.domain}
                        <ExternalLink style={{ width: '12px', height: '12px' }} />
                      </a>
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '12px' }}>
                    <div style={{ padding: '8px', backgroundColor: 'white', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '600' }}>Industry</div>
                      <div style={{ fontSize: '12px', color: '#111827' }}>{company.icp_classification.industry}</div>
                    </div>

                    <div style={{ padding: '8px', backgroundColor: 'white', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '600' }}>Employees</div>
                      <div style={{ fontSize: '12px', color: '#111827' }}>{company.icp_classification.employees}</div>
                    </div>

                    <div style={{ padding: '8px', backgroundColor: 'white', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '600' }}>Supplier Type</div>
                      <div style={{ fontSize: '12px', color: '#111827' }}>{company.icp_classification.supplier_type}</div>
                    </div>

                    <div style={{ padding: '8px', backgroundColor: 'white', borderRadius: '6px' }}>
                      <div style={{ fontSize: '11px', color: '#6b7280', fontWeight: '600' }}>Distribution</div>
                      <div style={{ fontSize: '12px', color: '#111827' }}>{company.icp_classification.distribution_area}</div>
                    </div>
                  </div>

                  <div style={{ padding: '12px', backgroundColor: 'white', borderRadius: '8px' }}>
                    <div style={{ fontSize: '11px', fontWeight: '600', color: '#111827', marginBottom: '4px' }}>
                      Analysis
                    </div>
                    <div style={{ fontSize: '12px', color: '#6b7280' }}>
                      {company.icp_classification.reason}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Contacts List */}
        {showContactsList && companiesWithContacts.length > 0 && (
          <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', marginBottom: '24px' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <div>
                <h2 style={{ fontSize: '24px', fontWeight: '600', color: '#111827' }}>
                  Found Contacts ({companiesWithContacts.reduce((sum, c) => sum + (c.contacts?.length || 0), 0)})
                </h2>
                <p style={{ fontSize: '13px', color: '#6b7280', marginTop: '4px' }}>
                  Select contacts to reveal their email and phone ‚Ä¢ {selectedContacts.length} selected
                </p>
              </div>
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={revealSelectedContacts}
                  disabled={revealingContacts || selectedContacts.length === 0}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: revealingContacts || selectedContacts.length === 0 ? '#d1d5db' : visableOrange,
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: revealingContacts || selectedContacts.length === 0 ? 'not-allowed' : 'pointer'
                  }}
                >
                  {revealingContacts ? 'Revealing...' : `üîì Reveal Selected (${selectedContacts.length})`}
                </button>
                <button
                  onClick={exportContactsToCSV}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: visableGreen,
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  <Download style={{ width: '16px', height: '16px' }} />
                  Export Contacts CSV
                </button>
                <button
                  onClick={() => setShowContactsList(false)}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: 'white',
                    color: '#374151',
                    border: '2px solid #e5e7eb',
                    borderRadius: '8px',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer'
                  }}
                >
                  Close
                </button>
              </div>
            </div>

            {revealProgress && (
              <div style={{
                padding: '16px',
                backgroundColor: '#eff6ff',
                borderRadius: '12px',
                marginBottom: '20px',
                border: '2px solid #3b82f6'
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <Loader style={{ width: '24px', height: '24px', color: '#3b82f6', animation: 'spin 1s linear infinite' }} />
                  <div style={{ color: '#1e40af', fontSize: '14px', fontWeight: '600' }}>
                    {revealProgress}
                  </div>
                </div>
              </div>
            )}

            <div style={{ display: 'grid', gap: '16px' }}>
              {companiesWithContacts.map((company, cidx) => (
                <div key={cidx} style={{
                  padding: '20px',
                  backgroundColor: '#f9fafb',
                  borderRadius: '12px',
                  border: '2px solid #e5e7eb'
                }}>
                  <div style={{ marginBottom: '16px' }}>
                    <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '4px' }}>
                      {company.name}
                    </h3>
                    <p style={{ fontSize: '13px', color: '#6b7280' }}>
                      {company.domain} ‚Ä¢ {company.icp_classification.industry}
                    </p>
                  </div>

                  {company.contactError ? (
                    <div style={{ padding: '12px', backgroundColor: '#fef2f2', borderRadius: '8px', color: '#991b1b', fontSize: '13px' }}>
                      ‚ö†Ô∏è {company.contactError}
                    </div>
                  ) : company.contacts && company.contacts.length > 0 ? (
                    <div style={{ display: 'grid', gap: '12px' }}>
                      {company.contacts.map((contact, idx) => (
                        <div 
                          key={idx}
                          onClick={() => !contact.revealed && toggleContactSelection(company.domain, contact.id)}
                          style={{
                            padding: '16px',
                            backgroundColor: 'white',
                            borderRadius: '8px',
                            border: contact.revealed ? '2px solid ' + visableGreen : isContactSelected(company.domain, contact.id) ? '2px solid ' + visableOrange : '2px solid #e5e7eb',
                            cursor: contact.revealed ? 'default' : 'pointer',
                            transition: 'all 0.2s'
                          }}
                        >
                          <div style={{ display: 'flex', alignItems: 'start', gap: '12px' }}>
                            {!contact.revealed && (
                              <input
                                type="checkbox"
                                checked={isContactSelected(company.domain, contact.id)}
                                onChange={() => toggleContactSelection(company.domain, contact.id)}
                                onClick={(e) => e.stopPropagation()}
                                style={{ width: '18px', height: '18px', cursor: 'pointer', marginTop: '2px' }}
                              />
                            )}
                            {contact.revealed && (
                              <span style={{ fontSize: '20px' }}>‚úÖ</span>
                            )}
                            <div style={{ flex: 1 }}>
                              <div style={{ fontSize: '16px', fontWeight: '600', color: '#111827', marginBottom: '4px' }}>
                                {contact.fullName || `${contact.firstName} ${contact.lastName}`}
                              </div>
                              <div style={{ fontSize: '13px', color: '#6b7280', marginBottom: '8px' }}>
                                {contact.title} ‚Ä¢ {contact.seniority}
                              </div>
                              {contact.revealed && (
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginTop: '8px' }}>
                                  {contact.email && (
                                    <div style={{ padding: '8px', backgroundColor: '#f0fdf4', borderRadius: '6px' }}>
                                      <div style={{ fontSize: '11px', color: '#166534', fontWeight: '600' }}>Email</div>
                                      <div style={{ fontSize: '12px', color: '#166534' }}>{contact.email}</div>
                                    </div>
                                  )}
                                  {contact.phone && (
                                    <div style={{ padding: '8px', backgroundColor: '#eff6ff', borderRadius: '6px' }}>
                                      <div style={{ fontSize: '11px', color: '#1e40af', fontWeight: '600' }}>Phone</div>
                                      <div style={{ fontSize: '12px', color: '#1e40af' }}>{contact.phone}</div>
                                    </div>
                                  )}
                                </div>
                              )}
                              {!contact.revealed && (
                                <div style={{ fontSize: '12px', color: '#9ca3af', fontStyle: 'italic' }}>
                                  Click to select for reveal
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div style={{ padding: '12px', backgroundColor: '#f3f4f6', borderRadius: '8px', color: '#6b7280', fontSize: '13px' }}>
                      No contacts found
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Empty State */}
        {!isSearching && results.length === 0 && !error && (
          <div style={{ backgroundColor: 'white', borderRadius: '12px', padding: '48px', boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1)', textAlign: 'center' }}>
            <Search style={{ width: '48px', height: '48px', color: '#9ca3af', margin: '0 auto 16px' }} />
            <h3 style={{ fontSize: '18px', fontWeight: '600', color: '#111827', marginBottom: '8px' }}>
              Start Your Search
            </h3>
            <p style={{ fontSize: '14px', color: '#6b7280' }}>
              Enter a semantic query or use filters to find companies
            </p>
          </div>
        )}
      </div>
    </div>
  );
}

// Render
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(CompanySearch));
  </script>
</body>
</html>
